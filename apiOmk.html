<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>API Omeka S – Ollavoice</title>

  <style>
    body{
      font-family: Arial, sans-serif;
      background:#ffffff;
      color:#111;
      margin:0;
      padding:0;
    }
    .container{
      max-width:900px;
      margin:30px auto;
      padding:20px;
    }
    h1{
      margin:0 0 15px 0;
      font-size:22px;
      font-weight:700;
    }
    h2{
      font-size:16px;
      margin:20px 0 10px;
      font-weight:700;
    }
    .card{
      border:1px solid #e5e5e5;
      border-radius:8px;
      padding:15px;
      margin-bottom:15px;
      background:#fafafa;
    }
    label{
      display:block;
      font-size:13px;
      margin:8px 0 5px;
      color:#333;
    }
    input, textarea{
      width:100%;
      box-sizing:border-box;
      padding:8px 10px;
      border:1px solid #ccc;
      border-radius:6px;
      background:#fff;
      font-size:14px;
    }
    input:focus, textarea:focus{
      outline:none;
      border-color:#888;
    }
    button{
      padding:8px 12px;
      margin-right:8px;
      margin-top:6px;
      border:1px solid #111;
      background:#fff;
      color:#111;
      border-radius:6px;
      cursor:pointer;
      font-weight:600;
      font-size:14px;
    }
    button:hover{
      background:#111;
      color:#fff;
    }
    .hint{
      font-size:12px;
      color:#666;
      margin-top:6px;
    }
    pre{
      background:#fff;
      border:1px solid #e5e5e5;
      border-radius:6px;
      padding:10px;
      max-height:360px;
      overflow:auto;
      font-size:12.5px;
      line-height:1.4;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>API Omeka S – Ollavoice</h1>

    <!-- Config -->
    <div class="card">
      <h2>Configuration API</h2>
      <label>URL de base de l’API</label>
      <input id="baseUrl" value="http://localhost/omeka-s/api" />
      <div class="hint">
        Les clés API sont déjà intégrées dans le code (le prof n’a rien à saisir).
      </div>
    </div>

    <!-- Items -->
    <div class="card">
      <h2>Lecture / écriture d’items</h2>
      <div class="row">
        <button id="btn-list">Lister les items</button>
        <button id="btn-create">Créer une note de test</button>
      </div>
      <div class="hint">Création = POST /items</div>
    </div>

    <!-- Upload -->
    <div class="card">
      <h2>Upload média (audio / vidéo)</h2>

      <label>Fichier à envoyer</label>
      <input type="file" id="fileInput"/>

      <label>ID de la note (item) à laquelle lier le fichier</label>
      <input id="itemId" type="number" value="1"/>

      <button id="btn-upload">Uploader le fichier</button>
      <div class="hint">Upload = POST /media avec ingester "upload"</div>
    </div>

    <!-- Result -->
    <div class="card">
      <h2>Résultat</h2>
      <pre id="output">Prêt.</pre>
    </div>
  </div>

  <script>
    /* =========================================================
       1) COnfiguration des clés API
       ========================================================= */
    const DEFAULT_KEY_ID   = "bdU2ZuVJR8Zj78n44sIWgQnPSZlVxtmZ";
    const DEFAULT_KEY_CRED = "jXVGjrYwAON1CPMIOzPfT0Yp8P1CdECH";

    function buildUrl(path) {
      const base = document.getElementById('baseUrl').value.replace(/\/$/, '');
      let url = base + path;

      if (DEFAULT_KEY_ID && DEFAULT_KEY_CRED) {
        url += (url.includes('?') ? '&' : '?')
          + 'key_identity=' + encodeURIComponent(DEFAULT_KEY_ID)
          + '&key_credential=' + encodeURIComponent(DEFAULT_KEY_CRED);
      }
      return url;
    }

    const out = document.getElementById('output');
    const show = (x) => out.textContent =
      (typeof x === "string") ? x : JSON.stringify(x, null, 2);

    // Lister items
    document.getElementById('btn-list').onclick = async () => {
      show("Chargement...");
      try {
        const res = await fetch(buildUrl('/items'));
        if (!res.ok) return show("Erreur API: " + res.status + " " + await res.text());
        show(await res.json());
      } catch (e) {
        show("Erreur JS: " + e);
      }
    };

    // Créer note de test
    document.getElementById('btn-create').onclick = async () => {
      show("Création...");
      const payload = {
        "o:is_public": true,
        "dcterms:title": [{ "@value": "Note créée via apiOmk.html", "type": "literal" }],
        "dcterms:date": [{ "@value": new Date().toISOString().slice(0,10), "type": "literal" }]
      };

      try {
        const res = await fetch(buildUrl('/items'), {
          method: "POST",
          headers: { "Content-Type": "application/json", "Accept":"application/json" },
          body: JSON.stringify(payload)
        });
        if (!res.ok) return show("Erreur API: " + res.status + " " + await res.text());
        show(await res.json());
      } catch(e){
        show("Erreur JS: " + e);
      }
    };

    // Upload média
    document.getElementById('btn-upload').onclick = async () => {
      const fileInput = document.getElementById('fileInput');
      const itemId = document.getElementById('itemId').value;

      if (!fileInput.files.length) return show("Choisis un fichier d'abord.");
      if (!itemId) return show("Mets un ID d'item valide.");

      const file = fileInput.files[0];

      const mediaData = {
        "o:ingester": "upload",
        "o:item": { "o:id": parseInt(itemId, 10) },
        "o:is_public": true,
        "dcterms:title": [{
          "type": "literal",
          "@value": "Fichier importé via apiOmk.html (" + file.name + ")"
        }]
      };

      const formData = new FormData();
      formData.append("data", JSON.stringify(mediaData));
      formData.append("file[0]", file, file.name);

      show("Upload en cours...");

      try {
        const res = await fetch(buildUrl('/media'), {
          method: "POST",
          body: formData,
          headers: { "Accept":"application/json" }
        });
        if (!res.ok) return show("Erreur upload: " + res.status + " " + await res.text());
        show(await res.json());
      } catch(e){
        show("Erreur JS: " + e);
      }
    };
  </script>
</body>
</html>
